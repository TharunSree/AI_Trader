<!-- File: templates/papertrading.html -->
{% extends "vertical.html" %}
{% load static %}
{% block title %}Paper Trading{% endblock title %}

{% block extra_css %}
<link href="{% static 'vendor/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet"
      type="text/css"/>
<style>
    .mini-badge {
        font-size: 11px;
        letter-spacing: .5px
    }

    .activity-log {
        max-height: 200px;
        overflow-y: auto
    }

    .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace
    }
</style>
{% endblock extra_css %}

{% block page_title %}
{% include 'partials/topbar.html' with topbarTitle='Paper Trading Bot' %}
{% endblock page_title %}

{% block page_content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h4 class="header-title mb-0">Live Equity Curve</h4>
                    <span class="text-muted small" id="points-count">0 pts</span>
                </div>
                <div id="equity-chart" style="min-height:360px;"></div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <!-- Left column: Account snapshot + Positions -->
    <div class="col-xl-6">
        <div class="card mb-3">
            <div class="card-body">
                <h4 class="header-title mb-3">Account Snapshot</h4>
                <div class="row g-3 mb-2">
                    <div class="col-sm-6">
                        <div class="p-3 rounded border h-100">
                            <div class="small text-muted text-uppercase fw-semibold">Equity</div>
                            <h4 id="equity-val" class="mb-0 mt-1">$0</h4>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="p-3 rounded border h-100">
                            <div class="small text-muted text-uppercase fw-semibold">Buying Power</div>
                            <h4 id="bp-val" class="mb-0 mt-1">$0</h4>
                        </div>
                    </div>
                </div>
                <hr/>
                <h5 class="header-title mb-2">Positions</h5>
                <table id="positions-dt" class="table table-sm table-striped nowrap w-100">
                    <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Qty</th>
                        <th>Value</th>
                        <th>Unrl P/L</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <small class="text-muted">Sorted by value.</small>
            </div>
        </div>
    </div>

    <!-- Right column: Controls + Status + Activity -->
    <div class="col-xl-6">
        <div class="card mb-3">
            <div class="card-body">
                <h4 class="header-title mb-3">Control Panel</h4>
                <form action="{% url 'start_trader' %}" method="POST" id="start-form" class="mb-3">
                    {% csrf_token %}
                    <div class="mb-2">
                        <label class="form-label small text-uppercase fw-semibold" for="model-file-select">Model
                            File</label>
                        <select name="model_file" id="model-file-select" class="form-select" required>
                            <option value="">Select model file</option>
                            {% for f in model_files %}
                            <option value="{{ f }}">{{ f }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="start-btn" type="submit" class="btn btn-success fw-semibold">
                            <i class="ri-play-line me-1"></i>Start
                        </button>
                        <button id="stop-btn" type="button" class="btn btn-danger fw-semibold" disabled>
                            <i class="ri-stop-line me-1"></i>Stop
                        </button>
                    </div>
                </form>
                <form id="stop-form" action="{% url 'stop_trader' %}" method="POST" class="d-none">{% csrf_token %}
                </form>
                <div class="small text-muted">
                    Interval configured inside session; reduce for more frequent actions.
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-body">
                <h4 class="header-title mb-3">Live Status</h4>
                <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
                    <span id="trader-status-badge"
                          class="badge bg-secondary-subtle text-secondary px-3 py-2">UNKNOWN</span>
                    <span class="badge bg-secondary-subtle text-secondary mini-badge" id="cycle-badge">IDLE</span>
                    <span class="badge bg-primary-subtle text-primary mini-badge d-none" id="analyzing-badge"></span>
                    <span class="badge bg-warning-subtle text-warning mini-badge d-none" id="sleep-badge"></span>
                    <span class="badge bg-dark-subtle text-dark mini-badge" id="uptime-badge">00:00:00</span>
                </div>
                <div id="error-icon" class="mb-2"></div>
                <div id="activity-summary" class="alert alert-info py-2 mb-3 small">No activity yet.</div>
                <h6 class="text-muted text-uppercase fw-semibold small mb-2">Recent Activity</h6>
                <ul id="activity-list" class="list-group activity-log small mb-2"></ul>
                <div class="small text-muted">Sleep countdown shown above; perâ€‘second entries suppressed.</div>
            </div>
        </div>
    </div>
</div>
{% endblock page_content %}

{% block extra_javascript %}
<script src="{% static 'vendor/apexcharts/apexcharts.min.js' %}"></script>
<script src="{% static 'vendor/datatables.net/js/dataTables.min.js' %}"></script>
<script src="{% static 'vendor/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>
<script>
    (function () {
        const UPTIME_KEY = 'paper_trader_uptime_start';
        const activityPollMs = 2500;
        const statusPoll = {RUNNING: 6000, STOPPED: 15000, FAILED: 10000, UNKNOWN: 10000};
        let currentStatus = 'UNKNOWN';
        let positionsTable, equityChart;
        const equitySeries = [];
        const MAX_POINTS = 800;
        const activityLog = [];
        const MAX_ACTIVITY = 60;
        let sleepSeconds = 0, sleepTimerId = null;
        let statusTimer = null, activityTimer = null;
        let lastNonSleepActivity = '';

        function fmt(n) {
            return Number(n || 0).toLocaleString();
        }

        function escapeHtml(s) {
            return (s || '').replace(/[&<>"'`]/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
                '`': '&#96;'
            }[c]));
        }

        function initPositions() {
            positionsTable = $('#positions-dt').DataTable({
                paging: false, searching: false, info: false, order: [[2, 'desc']],
                columnDefs: [{targets: [1, 2, 3], className: 'text-end'}]
            });
        }

        function initChart() {
            equityChart = new ApexCharts(document.querySelector('#equity-chart'), {
                chart: {type: 'area', height: 360, toolbar: {show: false}},
                series: [{name: 'Equity', data: []}],
                xaxis: {type: 'datetime'},
                yaxis: {labels: {formatter: v => '$' + fmt(v)}},
                dataLabels: {enabled: false},
                stroke: {curve: 'smooth', width: 2},
                colors: ['#35b8e0'],
                fill: {
                    type: 'gradient',
                    gradient: {shadeIntensity: .4, opacityFrom: .6, opacityTo: .1, stops: [0, 90, 100]}
                }
            });
            equityChart.render();
        }

        function addEquityPoint(val) {
            const last = equitySeries[equitySeries.length - 1];
            if (!last || last.y !== val) {
                equitySeries.push({x: Date.now(), y: val});
                if (equitySeries.length > MAX_POINTS) equitySeries.splice(0, equitySeries.length - MAX_POINTS);
                equityChart.updateSeries([{name: 'Equity', data: equitySeries}]);
                document.getElementById('points-count').textContent = equitySeries.length + ' pts';
            }
        }

        function setBadge(el, text, cls) {
            el.textContent = text;
            el.className = 'badge ' + cls;
        }

        function statusBadgeClass(s) {
            if (s === 'RUNNING') return 'bg-success-subtle text-success px-3 py-2';
            if (s === 'FAILED') return 'bg-danger-subtle text-danger px-3 py-2';
            if (s === 'STOPPED') return 'bg-secondary-subtle text-secondary px-3 py-2';
            return 'bg-secondary-subtle text-secondary px-3 py-2';
        }

        function ensureUptimeStart() {
            if (!localStorage.getItem(UPTIME_KEY)) {
                localStorage.setItem(UPTIME_KEY, Date.now().toString());
            }
        }

        function clearUptime() {
            localStorage.removeItem(UPTIME_KEY);
            document.getElementById('uptime-badge').textContent = '00:00:00';
        }

        function tickUptime() {
            const start = parseInt(localStorage.getItem(UPTIME_KEY) || '0', 10);
            if (!start) {
                requestAnimationFrame(tickUptime);
                return;
            }
            const diff = Date.now() - start;
            const h = String(Math.floor(diff / 3600000)).padStart(2, '0');
            const m = String(Math.floor(diff / 60000) % 60).padStart(2, '0');
            const s = String(Math.floor(diff / 1000) % 60).padStart(2, '0');
            document.getElementById('uptime-badge').textContent = `${h}:${m}:${s}`;
            requestAnimationFrame(tickUptime);
        }

        function scheduleStatus() {
            if (statusTimer) clearTimeout(statusTimer);
            statusTimer = setTimeout(fetchStatus, statusPoll[currentStatus] || 10000);
        }

        function scheduleActivity() {
            if (activityTimer) clearTimeout(activityTimer);
            activityTimer = setTimeout(fetchActivity, activityPollMs);
        }

        function addActivity(line, isError) {
            if (!line) return;
            // Filter sleep countdown spam
            if (/Sleeping\.\.\./.test(line)) return;
            if (line === lastNonSleepActivity) return;
            lastNonSleepActivity = line;
            activityLog.unshift({t: new Date(), msg: line, err: !!isError});
            if (activityLog.length > MAX_ACTIVITY) activityLog.pop();
            const ul = document.getElementById('activity-list');
            ul.innerHTML = '';
            activityLog.forEach(a => {
                const li = document.createElement('li');
                li.className = 'list-group-item py-1 d-flex justify-content-between ' + (a.err ? 'text-danger' : '');
                li.innerHTML = `<span class="text-truncate" style="max-width:70%">${escapeHtml(a.msg)}</span><code class="small mono mb-0">${a.t.toLocaleTimeString()}</code>`;
                ul.appendChild(li);
            });
            interpretCycle(line);
        }

        function interpretCycle(text) {
            const cycle = document.getElementById('cycle-badge');
            const analyzing = document.getElementById('analyzing-badge');
            const sleepB = document.getElementById('sleep-badge');
            analyzing.classList.add('d-none');
            if (/Scanning for opportunities/i.test(text)) {
                setBadge(cycle, 'SCANNING', 'mini-badge bg-info-subtle text-info');
            } else if (/^Analyzing (\w+)/i.test(text)) {
                const sym = text.split(' ')[1].replace(/[^A-Z.]/g, '');
                setBadge(cycle, 'ANALYZING', 'mini-badge bg-primary-subtle text-primary');
                analyzing.textContent = sym;
                analyzing.classList.remove('d-none');
            } else {
                if (currentStatus === 'RUNNING') setBadge(cycle, 'ACTIVE', 'mini-badge bg-success-subtle text-success');
                else setBadge(cycle, 'IDLE', 'mini-badge bg-secondary-subtle text-secondary');
            }
            // Sleep badge handled separately
        }

        function startSleepTimer() {
            const sleepB = document.getElementById('sleep-badge');
            sleepB.classList.remove('d-none');
            updateSleepBadge();
            if (sleepTimerId) clearInterval(sleepTimerId);
            sleepTimerId = setInterval(() => {
                if (sleepSeconds > 0) {
                    sleepSeconds--;
                    updateSleepBadge();
                } else {
                    clearInterval(sleepTimerId);
                    sleepB.classList.add('d-none');
                }
            }, 1000);
        }

        function updateSleepBadge() {
            const m = String(Math.floor(sleepSeconds / 60)).padStart(2, '0');
            const s = String(sleepSeconds % 60).padStart(2, '0');
            document.getElementById('sleep-badge').textContent = `Sleep ${m}:${s}`;
        }

        function processActivityString(str) {
            if (/Sleeping\.\.\./.test(str)) {
                const m = str.match(/Sleeping\.\.\. \((\d{2}):(\d{2}) remaining\)/);
                if (m) {
                    sleepSeconds = parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
                    startSleepTimer();
                    const cycle = document.getElementById('cycle-badge');
                    setBadge(cycle, 'SLEEPING', 'mini-badge bg-warning-subtle text-warning');
                }
            } else {
                addActivity(str, false);
                document.getElementById('activity-summary').textContent = str;
                const box = document.getElementById('activity-summary');
                box.classList.remove('alert-danger');
                box.classList.add('alert-info');
            }
        }

        function fetchStatus() {
            fetch("{% url 'trader_status_api' %}?_=" + Date.now(), {cache: 'no-store'})
                .then(r => r.json())
                .then(data => {
                    const prev = currentStatus;
                    currentStatus = data.status;
                    const badge = document.getElementById('trader-status-badge');
                    badge.className = 'badge ' + statusBadgeClass(currentStatus);
                    badge.textContent = currentStatus;
                    document.getElementById('equity-val').textContent = '$' + fmt(data.equity);
                    document.getElementById('bp-val').textContent = '$' + fmt(data.buying_power);
                    document.getElementById('start-btn').disabled = currentStatus === 'RUNNING';
                    document.getElementById('stop-btn').disabled = currentStatus !== 'RUNNING';

                    if (currentStatus === 'RUNNING') {
                        ensureUptimeStart();
                        addEquityPoint(Number(data.equity || 0));
                    } else {
                        clearUptime();
                    }

                    const errIcon = document.getElementById('error-icon');
                    if (currentStatus === 'FAILED') {
                        const msg = escapeHtml(data.error_message || 'Failure');
                        errIcon.innerHTML = `<span class="text-danger small"><i class="ri-error-warning-line"></i> ${msg}</span>`;
                        addActivity(data.error_message || 'Trader failed', true);
                        const box = document.getElementById('activity-summary');
                        box.textContent = data.error_message || 'Trader failed';
                        box.classList.remove('alert-info');
                        box.classList.add('alert-danger');
                    } else errIcon.innerHTML = '';

                    const sorted = (data.positions || []).slice().sort((a, b) => Number(b.market_value || 0) - Number(a.market_value || 0));
                    positionsTable.clear();
                    sorted.forEach(p => {
                        const pl = Number(p.unrealized_pl || 0);
                        positionsTable.row.add([
                            escapeHtml(p.symbol),
                            fmt(p.qty),
                            '$' + fmt(p.market_value || 0),
                            `<span class="${pl >= 0 ? 'text-success' : 'text-danger'}">$${fmt(pl)}</span>`
                        ]);
                    });
                    positionsTable.draw();

                    scheduleStatus();
                })
                .catch(() => scheduleStatus());
        }

        function fetchActivity() {
            if (currentStatus !== 'RUNNING') {
                scheduleActivity();
                return;
            }
            fetch("{% url 'trader_activity_api' %}?_=" + Date.now(), {cache: 'no-store'})
                .then(r => r.json())
                .then(d => {
                    if (d.activity) {
                        processActivityString(d.activity);
                    }
                    scheduleActivity();
                })
                .catch(() => scheduleActivity());
        }

        function wireControls() {
            document.getElementById('stop-btn').addEventListener('click', () => {
                document.getElementById('stop-form').submit();
            });
        }

        function boot() {
            initPositions();
            initChart();
            wireControls();
            fetchStatus();
            fetchActivity();
            tickUptime();
        }

        document.addEventListener('DOMContentLoaded', boot);
    })();
</script>
{% endblock extra_javascript %}