{% extends "vertical.html" %}
{% load static %}

{% block title %}Paper Trading{% endblock title %}

{% block extra_css %}
    <link href="{% static 'vendor/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet" type="text/css" />
{% endblock extra_css %}

{% block page_title %}
    {% include 'partials/topbar.html' with topbarTitle='Paper Trading Bot' %}
{% endblock page_title %}

{% block page_content %}
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-lg-6">
                            <h4 class="header-title">Control Panel</h4>
                            <p class="text-muted font-14">
                                Select a trained model and launch the live paper trading bot.
                            </p>

                            <form action="{% url 'start_trader' %}" method="POST" class="mb-2">
                                {% csrf_token %}
                                <div class="input-group">
                                    <select class="form-select" id="model_file_select" name="model_file" required>
                                        {% for model in model_files %}
                                            <option value="{{ model }}">{{ model }}</option>
                                        {% empty %}
                                            <option value="" disabled>No trained models found</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="btn btn-success" id="start-btn"><i class="ri-play-fill me-1"></i> Start Trader</button>
                                </div>
                            </form>

                            <form action="{% url 'stop_trader' %}" method="POST">
                                {% csrf_token %}
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-danger" id="stop-btn"><i class="ri-stop-fill me-1"></i> Stop Trader</button>
                                </div>
                            </form>
                        </div>
                        <div class="col-lg-6">
                            <h4 class="header-title mt-3 mt-lg-0">Live Status</h4>
                            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                <p class="mb-0">Status:</p>
                                <div>
                                    <span id="trader-status-badge" class="badge bg-secondary-subtle text-secondary">-</span>
                                    <span id="trader-error-tooltip-container"></span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between border-bottom py-2">
                                <p class="mb-0">Account Equity:</p>
                                <span id="account-equity" class="fw-semibold">-</span>
                            </div>
                            <div class="d-flex justify-content-between py-2">
                                <p class="mb-0">Buying Power:</p>
                                <span id="buying-power" class="fw-semibold">-</span>
                            </div>
                            <h5 class="mt-2">Current Activity:</h5>
                            <div class="alert alert-info bg-info-subtle border-0 mb-0" role="alert" id="trader-activity-log">
                                Waiting for status...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% endblock page_content %}

{% block extra_javascript %}
    <script>
        $(document).ready(function() {
            // ... (table and chart init are the same)

            function updateStatus(data) {
                const statusBadge = $('#trader-status-badge');
                // ... (badge text and class logic is the same)

                // --- NEW: Logic to add/remove error tooltip ---
                const errorContainer = $('#trader-error-tooltip-container');
                if (data.status === 'FAILED' && data.error_message) {
                    const errorHtml = `<span class="ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="${data.error_message}"><i class="ri-information-line text-danger"></i></span>`;
                    errorContainer.html(errorHtml);
                    // Re-initialize tooltips on the page
                    $('[data-bs-toggle="tooltip"]').tooltip();
                } else {
                    errorContainer.html(''); // Clear the error icon if status is not FAILED
                }

                // ... (rest of the updateStatus function is the same)
            }

            // ... (fetchTraderStatus and fetchTraderActivity functions are the same)
        });
    </script>
{% endblock extra_javascript %}