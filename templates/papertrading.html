{% extends "vertical.html" %}
{% load static %}

{% block title %}Paper Trading{% endblock title %}

{% block extra_css %}
<link href="{% static 'vendor/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet"
      type="text/css"/>
{% endblock extra_css %}

{% block page_title %}
{% include 'partials/topbar.html' with topbarTitle='Paper Trading Bot' %}
{% endblock page_title %}

{% block page_content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <h4 class="header-title">Control Panel</h4>
                        <p class="text-muted font-14">
                            Select a trained model and launch the live paper trading bot.
                        </p>

                        <form action="{% url 'start_trader' %}" method="POST" class="mb-2">
                            {% csrf_token %}
                            <div class="input-group">
                                <select class="form-select" id="model_file_select" name="model_file" required>
                                    {% for model in model_files %}
                                    <option value="{{ model }}">{{ model }}</option>
                                    {% empty %}
                                    <option value="" disabled>No trained models found in /saved_models/</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn btn-success" id="start-btn"><i
                                        class="ri-play-fill me-1"></i> Start Trader
                                </button>
                            </div>
                        </form>

                        <form action="{% url 'stop_trader' %}" method="POST">
                            {% csrf_token %}
                            <div class="d-grid">
                                <button type="submit" class="btn btn-danger" id="stop-btn"><i
                                        class="ri-stop-fill me-1"></i> Stop Trader
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="col-lg-6">
                        <h4 class="header-title mt-3 mt-lg-0">Live Status</h4>
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <p class="mb-0">Status:</p>
                            <div>
                                <span id="trader-status-badge" class="badge bg-secondary-subtle text-secondary">-</span>
                                <span id="trader-error-tooltip-container"></span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between border-bottom py-2">
                            <p class="mb-0">Account Equity:</p>
                            <span id="account-equity" class="fw-semibold">-</span>
                        </div>
                        <div class="d-flex justify-content-between py-2">
                            <p class="mb-0">Buying Power:</p>
                            <span id="buying-power" class="fw-semibold">-</span>
                        </div>
                        <h5 class="mt-2">Current Activity:</h5>
                        <div class="alert alert-info bg-info-subtle border-0 mb-0" role="alert"
                             id="trader-activity-log">
                            Waiting for status...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <h4 class="header-title mb-4">Live Equity Curve</h4>
                <div id="live-equity-chart" class="apex-charts" data-colors="#35b8e0"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <h4 class="header-title">Current Positions</h4>
                <table id="positions-datatable" class="table table-striped dt-responsive nowrap w-100">
                    <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Quantity</th>
                        <th>Market Value</th>
                        <th>Unrealized P/L</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock page_content %}

{% block extra_javascript %}
<script src="{% static 'vendor/apexcharts/apexcharts.min.js' %}"></script>
<script src="{% static 'vendor/datatables.net/js/dataTables.min.js' %}"></script>
<script src="{% static 'vendor/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>
// templates/papertrading.html (replace existing script block)
<script>
$(document).ready(function () {
    const positionsTable = $('#positions-datatable').DataTable({paging:false, info:false, searching:false});

    function escapeHtml(str){
        return (str||'').replace(/[&<>"'`]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c]));
    }

    function setActivity(text, isError){
        $('#trader-activity-log')
            .text(text)
            .toggleClass('alert-danger', !!isError)
            .toggleClass('alert-info', !isError);
    }

    function updateStatusUI(data){
        const badge = $('#trader-status-badge');
        badge.text(data.status)
             .removeClass('bg-success-subtle text-success bg-danger-subtle text-danger bg-secondary-subtle text-secondary')
             .addClass(
                data.status === 'RUNNING' ? 'bg-success-subtle text-success' :
                data.status === 'FAILED'  ? 'bg-danger-subtle text-danger'  :
                                            'bg-secondary-subtle text-secondary'
             );

        const errorContainer = $('#trader-error-tooltip-container');
        if (data.status === 'FAILED') {
            const msg = escapeHtml(data.error_message || 'Trader failed. No error details.');
            errorContainer.html(`<span class="ms-1" data-bs-toggle="tooltip" title="${msg}"><i class="ri-information-line text-danger"></i></span>`);
            $('[data-bs-toggle="tooltip"]').tooltip();
        } else {
            errorContainer.empty();
        }

        $('#start-btn').prop('disabled', data.status === 'RUNNING');
        $('#stop-btn').prop('disabled', data.status !== 'RUNNING');

        $('#account-equity').text('$' + (Number(data.equity||0).toLocaleString()));
        $('#buying-power').text('$' + (Number(data.buying_power||0).toLocaleString()));

        positionsTable.clear();
        if (Array.isArray(data.positions)) {
            data.positions.forEach(p=>{
                const pl = parseFloat(p.unrealized_pl);
                positionsTable.row.add([
                    p.symbol,
                    p.qty,
                    '$' + Number(p.market_value).toLocaleString(),
                    `<span class="${pl>=0?'text-success':'text-danger'}">$${pl.toLocaleString()}</span>`
                ]);
            });
        }
        positionsTable.draw();
    }

    function fetchTraderStatus(){
        fetch('/api/trader-status/?_=' + Date.now(), {cache:'no-store'})
            .then(r=>{
                if(!r.ok) throw new Error('HTTP '+r.status);
                return r.json();
            })
            .then(data=>{
                console.log('trader-status payload:', data);
                updateStatusUI(data);
                if (data.status === 'FAILED') {
                    setActivity(data.error_message || 'Trader failed. No error details.', true);
                } else if (data.status === 'RUNNING') {
                    if (!$('#trader-activity-log').hasClass('alert-danger')) {
                        setActivity('Running...', false);
                    }
                } else {
                    if (!$('#trader-activity-log').hasClass('alert-danger')) {
                        setActivity('Idle (not running)', false);
                    }
                }
            })
            .catch(err=>{
                console.error('Status fetch error', err);
                setActivity('Network / API error fetching status.', true);
            });
    }

    function fetchTraderActivity(){
        if ($('#trader-activity-log').hasClass('alert-danger')) return; // do not overwrite error
        fetch('/api/trader-activity/?_=' + Date.now(), {cache:'no-store'})
            .then(r=> r.ok ? r.json() : Promise.reject('HTTP '+r.status))
            .then(data=>{
                if (data.activity && !$('#trader-activity-log').hasClass('alert-danger')) {
                    setActivity(data.activity, false);
                }
            })
            .catch(()=>{/* silent */});
    }

    fetchTraderStatus();
    fetchTraderActivity();
    setInterval(fetchTraderStatus, 8000);
    setInterval(fetchTraderActivity, 2000);
});
</script>
{% endblock extra_javascript %}