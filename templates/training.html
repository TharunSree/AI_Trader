{% extends "vertical.html" %}
{% load static %}

{% block title %}Training Control{% endblock title %}

{% block extra_css %}
<link href="{% static 'vendor/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet" type="text/css"/>
{% endblock extra_css %}

{% block page_title %}
{% include 'partials/topbar.html' with topbarTitle='AI Model Training' %}
{% endblock page_title %}

{% block page_content %}
<div class="row">
    <!-- Meta Training Launcher -->
    <div class="col-lg-12">
        <div class="card border-primary border">
            <div class="card-body">
                <h4 class="header-title text-primary">Master Coach: Find the Best Agent</h4>
                <p class="text-muted font-14">
                    Launch a meta-training experiment to test multiple strategies and record the best performer.
                </p>
                <form action="{% url 'start_meta_job' %}" method="POST">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="meta_initial_cash" class="form-label">Initial Cash ($)</label>
                            <input type="number" id="meta_initial_cash" name="initial_cash" class="form-control"
                                   value="100000" step="1000" min="10000" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="meta_target_equity" class="form-label">Target Equity ($)</label>
                            <input type="number" id="meta_target_equity" name="target_equity" class="form-control"
                                   value="150000" step="1000" min="100000">
                        </div>
                        <div class="col-md-4 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="mdi mdi-rocket-launch me-1"></i> Launch Meta Training
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Single Training Job Launcher -->
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <h4 class="header-title">Start New Training Job</h4>
                <p class="text-muted font-14">
                    Select configuration and start a single training run.
                </p>
                <form action="{% url 'start_training_job' %}" method="POST">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="feature_set_key" class="form-label">Feature Set</label>
                            <select class="form-select" id="feature_set_key" name="feature_set_key">
                                {% for key,val in playbook.feature_sets.items %}
                                <option value="{{ key }}">{{ key|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="hyperparameter_key" class="form-label">Hyperparameters</label>
                            <select class="form-select" id="hyperparameter_key" name="hyperparameter_key">
                                {% for key,val in playbook.hyperparameters.items %}
                                <option value="{{ key }}">{{ key|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="window_size" class="form-label">Window Size (days)</label>
                            <select class="form-select" id="window_size" name="window_size">
                                <option value="5">5 days (Very Short)</option>
                                <option value="8">8 days (Short)</option>
                                <option value="10" selected>10 days (Standard)</option>
                                <option value="15">15 days (Medium)</option>
                                <option value="20">20 days (Long)</option>
                                <option value="30">30 days (Very Long)</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="initial_cash" class="form-label">Initial Cash ($)</label>
                            <input type="number" id="initial_cash" name="initial_cash" class="form-control"
                                   value="100000" step="1" min="1" required>
                        </div>
                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="mdi mdi-play me-1"></i> Start Training
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Meta Training Jobs Table -->
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <h4 class="header-title">Meta Training Jobs</h4>
                <div class="table-responsive">
                    <table id="meta-training-table" class="table table-striped dt-responsive nowrap w-100">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Status</th>
                            <th>Progress</th>
                            <th>Best Sharpe</th>
                            <th>Start Time</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for job in meta_training_jobs %}
                        <tr>
                            <td>{{ job.id }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ job.status }}</span>
                            </td>
                            <td>{{ job.progress|default:0 }}%</td>
                            <td>
                                {% if job.results %}
                                    {{ job.results.sharpe_ratio|floatformat:3|default:"N/A" }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{{ job.start_time|date:"M d, H:i"|default:"Not started" }}</td>
                            <td>
                                {% if job.status == 'RUNNING' %}
                                <form action="{% url 'stop_meta_job' job.id %}" method="POST" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">Stop</button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Training Jobs Table -->
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <h4 class="header-title">Training Jobs</h4>
                <div class="table-responsive">
                    <table id="training-jobs-table" class="table table-striped dt-responsive nowrap w-100">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Status</th>
                            <th>Features</th>
                            <th>Hyperparameters</th>
                            <th>Window</th>
                            <th>Progress</th>
                            <th>Best Reward</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for job in training_jobs %}
                        <tr>
                            <td>{{ job.id }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ job.status }}</span>
                            </td>
                            <td>{{ job.feature_set_key }}</td>
                            <td>{{ job.hyperparameter_key }}</td>
                            <td>{{ job.window_size }}</td>
                            <td>{{ job.progress|default:0 }}%</td>
                            <td>{{ job.best_reward|floatformat:2|default:"0.00" }}</td>
                            <td>
                                {% if job.status == 'RUNNING' %}
                                <form action="{% url 'stop_job' job.id %}" method="POST" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">Stop</button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock page_content %}

{% block extra_javascript %}
<script src="{% static 'vendor/datatables.net/js/dataTables.min.js' %}"></script>
<script src="{% static 'vendor/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>
<script>
(function(){
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function buildStatusBadge(status) {
        const statusClasses = {
            'PENDING': 'bg-warning',
            'RUNNING': 'bg-info',
            'COMPLETED': 'bg-success',
            'FAILED': 'bg-danger',
            'STOPPED': 'bg-secondary'
        };
        const badgeClass = statusClasses[status] || 'bg-secondary';
        return `<span class="badge ${badgeClass}">${escapeHtml(status)}</span>`;
    }

    function updateTables(data) {
        // Update training jobs table
        const trainingTableBody = document.querySelector('#training-jobs-table tbody');
        if (trainingTableBody && data.training_jobs) {
            trainingTableBody.innerHTML = '';
            data.training_jobs.forEach(job => {
                const stopButton = job.status === 'RUNNING' ?
                    `<form action="/training/stop/${job.id}/" method="POST" style="display:inline;">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                        <button type="submit" class="btn btn-sm btn-danger">Stop</button>
                     </form>` : '';

                const row = `
                    <tr>
                        <td>${job.id}</td>
                        <td>${buildStatusBadge(job.status)}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>${job.progress || 0}%</td>
                        <td>${job.best_reward || '0.00'}</td>
                        <td>${stopButton}</td>
                    </tr>
                `;
                trainingTableBody.innerHTML += row;
            });
        }

        // Update meta training jobs table
        const metaTableBody = document.querySelector('#meta-training-table tbody');
        if (metaTableBody && data.meta_training_jobs) {
            metaTableBody.innerHTML = '';
            data.meta_training_jobs.forEach(job => {
                const stopButton = job.status === 'RUNNING' ?
                    `<form action="/training/meta/stop/${job.id}/" method="POST" style="display:inline;">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                        <button type="submit" class="btn btn-sm btn-danger">Stop</button>
                     </form>` : '';

                const row = `
                    <tr>
                        <td>${job.id}</td>
                        <td>${buildStatusBadge(job.status)}</td>
                        <td>${job.progress || 0}%</td>
                        <td>${job.best_sharpe_ratio ? job.best_sharpe_ratio.toFixed(3) : 'N/A'}</td>
                        <td>-</td>
                        <td>${stopButton}</td>
                    </tr>
                `;
                metaTableBody.innerHTML += row;
            });
        }
    }

    function fetchJobStatus() {
        fetch('/api/job-status/')
            .then(response => response.json())
            .then(data => updateTables(data))
            .catch(error => console.error('Error fetching job status:', error));
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize DataTables
        if (document.getElementById('training-jobs-table')) {
            $('#training-jobs-table').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[0, 'desc']]
            });
        }

        if (document.getElementById('meta-training-table')) {
            $('#meta-training-table').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[0, 'desc']]
            });
        }

        // Start polling for updates
        fetchJobStatus();
        setInterval(fetchJobStatus, 3000);
    });
})();
</script>
{% endblock extra_javascript %}