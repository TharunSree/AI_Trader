{% extends "vertical.html" %}
{% load static %}
{% block title %}Trader Report{% endblock title %}

{% block extra_css %}
<link href="{% static 'vendor/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet" type="text/css"/>
<link href="{% static 'vendor/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css' %}" rel="stylesheet" type="text/css"/>
{% endblock extra_css %}

{% block page_title %}
{% include 'partials/topbar.html' with topbarTitle='Paper Trader Performance Report' %}
{% endblock page_title %}

{% block page_content %}

<div class="row">
    <div class="col-xl-3 col-lg-6">
        <div class="card widget-flat">
            <div class="card-body">
                <div class="float-end">
                    <i class="mdi mdi-swap-horizontal widget-icon"></i>
                </div>
                <h5 class="text-muted fw-normal mt-0" title="Total Trades">Total Trades</h5>
                <h3 class="mt-3 mb-3">{{ total_trades }}</h3>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6">
        <div class="card widget-flat">
            <div class="card-body">
                <div class="float-end">
                    <i class="mdi mdi-chart-line widget-icon bg-success-lighten text-success"></i>
                </div>
                <h5 class="text-muted fw-normal mt-0" title="Gross Profit/Loss">Gross P&L</h5>
                <h3 class="mt-3 mb-3 {% if gross_pnl > 0 %}text-success{% elif gross_pnl < 0 %}text-danger{% endif %}">
                    ${{ gross_pnl|floatformat:2 }}
                </h3>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6">
        <div class="card widget-flat">
            <div class="card-body">
                <div class="float-end">
                    <i class="mdi mdi-currency-usd widget-icon"></i>
                </div>
                <h5 class="text-muted fw-normal mt-0" title="Total Volume Traded">Total Volume</h5>
                <h3 class="mt-3 mb-3">${{ total_volume|floatformat:2 }}</h3>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-6">
        <div class="card widget-flat">
            <div class="card-body">
                <div class="float-end">
                    <i class="mdi mdi-chart-pie widget-icon bg-warning-lighten text-warning"></i>
                </div>
                <h5 class="text-muted fw-normal mt-0" title="Buy vs Sell Count">Trade Distribution</h5>
                <h3 class="mt-3 mb-3">{{ buy_count }} Buys / {{ sell_count }} Sells</h3>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h4 class="header-title">Complete Trade History</h4>
                <p class="text-muted font-14">
                    A log of all simulated trades executed by the paper trading bot.
                </p>

                <table id="trade-log-datatable" class="table table-striped dt-responsive nowrap w-100">
                    <thead class="table-light">
                        <tr>
                            <th>Timestamp</th>
                            <th>Symbol</th>
                            <th>Action</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Notional Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in all_trades %}
                        <tr>
                            <td>{{ trade.timestamp|date:"Y-m-d H:i:s" }}</td>
                            <td>{{ trade.symbol }}</td>
                            <td>
                                {% if trade.action == 'BUY' %}
                                <span class="badge bg-success-lighten text-success">{{ trade.action }}</span>
                                {% else %}
                                <span class="badge bg-danger-lighten text-danger">{{ trade.action }}</span>
                                {% endif %}
                            </td>
                            <td>{{ trade.quantity|floatformat:6 }}</td>
                            <td>${{ trade.price|floatformat:2 }}</td>
                            <td>${{ trade.notional_value|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock page_content %}

{% block extra_js %}
<script src="{% static 'vendor/datatables.net/js/dataTables.min.js' %}"></script>
<script src="{% static 'vendor/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>
<script src="{% static 'vendor/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'vendor/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js' %}"></script>

<script>
    $(document).ready(function() {
        $('#trade-log-datatable').DataTable({
            "order": [[ 0, "desc" ]] // Order by the first column (Timestamp) descending
        });
    });
</script>
{% endblock extra_js %}